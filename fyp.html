<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEBLUG â€“ FYP</title>
<link href="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" rel="preload" as="script">
<style>
:root {
  --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --card:#f9fafb;
}
body.dark { --bg:#1e293b; --text:#f8fafc; --muted:#94a3b8; --border:#475569; --card:#0f172a; }
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{background:var(--bg); color:var(--text); min-height:100vh; padding-bottom:60px;}

header{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--bg); z-index:100;}
.logo{font-weight:700; font-size:18px;}
.icon-btn{background:none; border:none; cursor:pointer; color: var(--text);}

main{padding:16px;}

.card{background:var(--card); border-radius:8px; padding:12px; margin-bottom:12px; position:relative;}
.card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.username{font-weight:600; cursor:pointer;}
.stat{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:4px; margin-right:12px;}

.view-more{color:var(--accent); font-size:12px; cursor:pointer; display:block; margin-top:4px;}

nav{position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; border-top:1px solid var(--border); background:var(--bg); padding:10px 0;}
nav a{text-decoration:none; color:var(--muted); font-size:11px; display:flex; flex-direction:column; align-items:center; gap:4px;}
nav a.active{color:var(--accent);}
</style>
</head>
<body>

<header>
  <div class="logo">DEBLUG</div>
  <button class="icon-btn" onclick="toggleTheme()"><i data-lucide="moon"></i></button>
</header>

<main id="feedContainer">
  <p style="text-align:center; color:var(--muted);">Loading posts...</p>
</main>

<nav>
  <a href="fyp.html" class="active"><i data-lucide="home"></i>FYP</a>
  <a href="#"><i data-lucide="plus-square"></i>Post</a>
  <a href="action.html"><i data-lucide="bell"></i>Notify</a>
  <a href="chat.html"><i data-lucide="message-square"></i>Chat</a>
  <a href="dashboard.html"><i data-lucide="user"></i>Profile</a>
</nav>

<script src="https://unpkg.com/lucide@latest"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.firebasestorage.app",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const feedContainer = document.getElementById("feedContainer");
let currentUser;

onAuthStateChanged(auth, user => {
  if(!user){ window.location.href="login.html"; return; }
  currentUser = user;
  loadFeed();
});

async function loadFeed(){
  const q = query(collection(db,"posts"), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  feedContainer.innerHTML='';
  if(snapshot.empty){ feedContainer.innerHTML='<p style="text-align:center; color:var(--muted);">No posts yet.</p>'; return; }

  snapshot.forEach(docSnap=>{
    const post = docSnap.data();
    const postEl = document.createElement('div');
    postEl.className='card';
    let content = post.content.replace(/\n/g,'<br>');

    // Collapse if more than 15 lines
    const lines = content.split('<br>');
    let isCollapsed = lines.length > 15;
    let displayContent = isCollapsed ? lines.slice(0,15).join('<br>') : content;
    
    postEl.innerHTML=`
      <div class="card-header">
        <span class="username">${post.username}</span>
        <div>
          <span class="stat"><i data-lucide="heart"></i> ${post.likes?.length||0}</span>
          <span class="stat"><i data-lucide="message-circle"></i> ${post.commentsCount||0}</span>
        </div>
      </div>
      <div class="content">${displayContent}</div>
      ${isCollapsed?'<span class="view-more">View More</span>':''}
      <div style="margin-top:8px;">
        <button onclick="likePost('${docSnap.id}')">Like</button>
        <button onclick="follow('${post.uid}')">Follow</button>
        <button onclick="sharePost('${docSnap.id}')">Share</button>
      </div>
    `;
    feedContainer.appendChild(postEl);
  });

  lucide.createIcons();

  // Handle view more clicks
  document.querySelectorAll('.view-more').forEach(el=>{
    el.addEventListener('click', e=>{
      const card = e.target.closest('.card');
      const content = card.querySelector('.content');
      const docId = e.target.closest('.card').dataset.docId;
      content.innerHTML = snapshot.docs.find(d=>d.id===docId).data().content.replace(/\n/g,'<br>');
      e.target.remove();
    });
  });
}

async function likePost(postId){
  const postRef = doc(db,"posts",postId);
  await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
  loadFeed();
}

async function follow(userId){
  alert("Follow feature placeholder (implement following system in Firestore)");
}

function sharePost(postId){
  alert("Share feature placeholder (copy post link etc.)");
}

function toggleTheme(){
  document.body.classList.toggle('dark');
}
</script>
</body>
</html>
