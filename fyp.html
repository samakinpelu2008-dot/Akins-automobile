<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEBLUG â€“ FYP</title>
  <link rel="stylesheet" href="css/styles.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/lucide@0.277.0/dist/lucide.min.js"></script>
</head>
<body>
  <header>
    <h1>DEBLUG Feed</h1>
    <button id="logoutBtn">Logout</button>
  </header>

  <main>
    <section id="postForm">
      <textarea id="postText" placeholder="What's happening?"></textarea>
      <button id="postBtn">Post</button>
    </section>

    <section id="feed"></section>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.firebasestorage.app",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logoutBtn = document.getElementById("logoutBtn");
const postBtn = document.getElementById("postBtn");
const postText = document.getElementById("postText");
const feed = document.getElementById("feed");

let currentUser;

// Check user login
onAuthStateChanged(auth, user => {
  if(!user){
    window.location.href = "login.html";
  } else {
    currentUser = user;
    loadPosts();
  }
});

// Logout
logoutBtn.addEventListener("click", ()=> signOut(auth).then(()=> window.location.href="login.html"));

// Posting
postBtn.addEventListener("click", async ()=>{
  const text = postText.value.trim();
  if(!text) return alert("Post cannot be empty");

  await addDoc(collection(db,"posts"),{
    uid: currentUser.uid,
    text,
    likes: [],
    comments: [],
    createdAt: Date.now()
  });
  postText.value = "";
});

// Load posts
function loadPosts(){
  const q = query(collection(db,"posts"), orderBy("createdAt","desc"));
  onSnapshot(q, snapshot => {
    feed.innerHTML = "";
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const postId = docSnap.id;
      const liked = data.likes.includes(currentUser.uid);
      const postEl = document.createElement("div");
      postEl.classList.add("post");

      // Collapsible text if longer than 3 lines
      let displayText = data.text;
      let collapsed = false;
      const lines = data.text.split(/\r?\n/);
      if(lines.length > 3){
        displayText = lines.slice(0,3).join("\n") + "...";
        collapsed = true;
      }

      postEl.innerHTML = `
        <p class="postText">${displayText}</p>
        ${collapsed ? '<button class="viewMoreBtn">View More</button>' : ''}
        <div class="actions">
          <button class="likeBtn">${liked ? '<i data-lucide="heart" style="color:red"></i>' : '<i data-lucide="heart"></i>'} ${data.likes.length}</button>
          <button class="commentBtn"><i data-lucide="message-circle"></i> ${data.comments.length}</button>
          <button class="shareBtn"><i data-lucide="share-2"></i></button>
        </div>
      `;

      feed.appendChild(postEl);
      lucide.createIcons();

      // View More toggle
      const viewMore = postEl.querySelector(".viewMoreBtn");
      if(viewMore){
        viewMore.addEventListener("click", ()=>{
          const p = postEl.querySelector(".postText");
          p.textContent = data.text;
          viewMore.style.display = "none";
        });
      }

      // Like button
      const likeBtn = postEl.querySelector(".likeBtn");
      likeBtn.addEventListener("click", async ()=>{
        const postRef = doc(db,"posts",postId);
        if(liked){
          alert("Unlike feature can be added");
        } else {
          await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
        }
      });

      // Comment button (basic prompt)
      const commentBtn = postEl.querySelector(".commentBtn");
      commentBtn.addEventListener("click", async ()=>{
        const comment = prompt("Add comment:");
        if(comment){
          const postRef = doc(db,"posts",postId);
          await updateDoc(postRef, { comments: arrayUnion({ uid: currentUser.uid, text: comment, createdAt: Date.now() }) });
        }
      });

      // Share button
      const shareBtn = postEl.querySelector(".shareBtn");
      shareBtn.addEventListener("click", ()=>{
        alert("Share functionality can be implemented here");
      });

    });
  });
}

</script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#0d1117;color:white}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#161b22}
textarea{width:100%;padding:10px;margin-bottom:5px;border-radius:5px;border:none;outline:none;background:#222;color:white}
button{padding:8px 12px;margin:5px;border:none;border-radius:5px;background:#238636;color:white;cursor:pointer}
.post{background:#161b22;padding:10px;margin:10px 0;border-radius:6px}
.actions button{margin-right:10px}
</style>
</body>
</html>
