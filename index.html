<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEBLUG – Sign Up</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="card">
  <!-- STEP 1: Email + Password -->
  <div id="step1">
    <h1>Sign Up for DEBLUG</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <input type="text" id="referral" placeholder="Referral code (optional)">
    <button id="nextStep">Next</button>
    <div id="status"></div>
    <div style="margin-top:10px; text-align:center; font-size:13px;">
      Already have an account? <a href="login.html">Login here</a>
    </div>
  </div>

  <!-- STEP 2: Username -->
  <div id="step2" class="hidden">
    <h2>Choose Username</h2>
    <input type="text" id="username" placeholder="Username" readonly>
    <button id="editUsernameBtn">Edit</button>
    <div id="usernameHint">
      <div id="charHint">Minimum 8 characters</div>
      <div id="numberHint">Must include at least 2 numbers</div>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="terms"> I agree to the <a href="#" id="termsLink">Terms & Conditions</a>
    </div>
    <button id="finishSignup" disabled>Finish Signup</button>
    <div id="usernameStatus"></div>
  </div>
</div>

<!-- Terms modal -->
<div id="termsModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Terms & Conditions</h3>
    <p>All content must follow rules. DEBLUG is not responsible for user content. Monetization rules apply. Enjoy safely!</p>
  </div>
</div>

<script type="module" src="js/firebase.js"></script>
<script type="module">
const step1 = document.getElementById("step1");
const step2 = document.getElementById("step2");
const nextStep = document.getElementById("nextStep");
const finishSignup = document.getElementById("finishSignup");
const usernameInput = document.getElementById("username");
const editBtn = document.getElementById("editUsernameBtn");
const charHint = document.getElementById("charHint");
const numberHint = document.getElementById("numberHint");
const usernameStatus = document.getElementById("usernameStatus");
const termsCheckbox = document.getElementById("terms");

let signupData = {};

// STEP 1 → STEP 2
nextStep.addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const referral = document.getElementById("referral").value.trim();
  const status = document.getElementById("status");

  if (!email || !password) { status.innerText = "Email and password required"; return; }

  status.innerText = "Checking email...";
  try {
    const userQuery = window.db.query(window.db.collection(window.db.db, "users"), window.db.where("email","==",email));
    const snap = await window.db.getDocs(userQuery);
    if (!snap.empty) { status.innerText = "Email already exists"; return; }

    signupData.email = email;
    signupData.password = password;
    signupData.referral = referral;
    step1.classList.add("hidden");
    step2.classList.remove("hidden");

    // Suggest username
    const countSnap = await window.db.getDocs(window.db.collection(window.db.db,"users"));
    const suggested = "user" + (countSnap.size + 1).toString().padStart(2,"0");
    usernameInput.value = suggested;
    validateUsername(); // initial validation

  } catch(err){ status.innerText = err.message; }
});

// Enable editing username
editBtn.addEventListener("click", () => { usernameInput.removeAttribute("readonly"); usernameInput.focus(); });

// Username validation
async function validateUsername() {
  const val = usernameInput.value.trim();
  const numCount = val.replace(/[^0-9]/g,"").length;
  charHint.style.color = val.length >= 8 ? "green" : "red";
  numberHint.style.color = numCount >=2 ? "green" : "red";

  if(charHint.style.color==="green" && numberHint.style.color==="green"){
    const q = window.db.query(window.db.collection(window.db.db,"users"), window.db.where("username","==",val.toLowerCase()));
    const snap = await window.db.getDocs(q);
    usernameStatus.innerText = !snap.empty ? "Already exists" : "Ready for use";
    usernameStatus.style.color = !snap.empty ? "red" : "green";
  } else { usernameStatus.innerText=""; }

  updateFinishBtn();
}

usernameInput.addEventListener("input", validateUsername);
termsCheckbox.addEventListener("change", updateFinishBtn);

function updateFinishBtn(){
  const ready = charHint.style.color==="green" && numberHint.style.color==="green" &&
                usernameStatus.innerText==="Ready for use" && termsCheckbox.checked;
  finishSignup.disabled = !ready;
}

// Finish signup
finishSignup.addEventListener("click", async () => {
  const username = usernameInput.value.trim().toLowerCase();
  try {
    const cred = await window.auth.createUserWithEmailAndPassword(signupData.email, signupData.password);
    const uid = cred.user.uid;

    await window.db.setDoc(window.db.doc(window.db.db,"users",uid),{
      email: signupData.email,
      username,
      referralCode: uid.slice(0,6),
      referredBy: signupData.referral||null,
      createdAt: Date.now(),
      followers:0,
      following:0,
      balance:0
    });

    usernameStatus.innerText="Account created! Redirecting...";
    setTimeout(()=>{ window.location.href="fyp.html"; },1500);
  } catch(err){ usernameStatus.innerText = err.message; }
});

// Terms modal
const termsLink = document.getElementById("termsLink");
const modal = document.getElementById("termsModal");
const closeModal = document.getElementById("closeModal");
termsLink.addEventListener("click", e=>{ e.preventDefault(); modal.style.display="block"; });
closeModal.addEventListener("click", ()=>{ modal.style.display="none"; });
window.addEventListener("click", e=>{ if(e.target==modal) modal.style.display="none"; });

</script>
</body>
</html>
