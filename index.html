<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEBLUG – Sign Up</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .card {
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    h1 { text-align: center; color: #38bdf8; }

    input {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    #usernameHint {
      font-size: 12px;
      margin-top: 4px;
      color: #ccc;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border-radius: 6px;
      border: none;
      background: #38bdf8;
      color: #020617;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover { background: #0ea5e9; }

    #status, #usernameStatus {
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
    }

    .hidden { display: none; }

  </style>
</head>
<body>

  <div class="card">

    <!-- STEP 1: Email + Password -->
    <div id="step1">
      <h1>DEBLUG Sign Up</h1>

      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <input type="text" id="referral" placeholder="Referral code (optional)">

      <button id="nextStep">Next</button>
      <div id="status"></div>
    </div>

    <!-- STEP 2: Username -->
    <div id="step2" class="hidden">
      <h2>Choose Username</h2>
      <input type="text" id="username" placeholder="Username">
      <button id="editUsernameBtn">Edit</button>
      <div id="usernameHint">
        Minimum 8 characters, must include at least 2 numbers
      </div>
      <button id="finishSignup">Finish Signup</button>
      <div id="usernameStatus"></div>
    </div>

  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, increment, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
      authDomain: "fir-chat-f8d55.firebaseapp.com",
      projectId: "fir-chat-f8d55",
      storageBucket: "fir-chat-f8d55.firebasestorage.app",
      messagingSenderId: "792896094694",
      appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const nextStep = document.getElementById("nextStep");
    const finishSignup = document.getElementById("finishSignup");

    let signupData = {};

    // Step 1 → Step 2
    nextStep.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const referral = document.getElementById("referral").value.trim();
      const status = document.getElementById("status");

      if (!email || !password) { status.innerText = "Email and password required"; return; }

      status.innerText = "Checking email...";
      try {
        const userQuery = query(collection(db, "users"), where("email", "==", email));
        const snap = await getDocs(userQuery);
        if (!snap.empty) { status.innerText = "Email already exists"; return; }

        signupData.email = email;
        signupData.password = password;
        signupData.referral = referral;
        step1.classList.add("hidden");
        step2.classList.remove("hidden");

        // Auto username
        const countSnap = await getDocs(collection(db, "users"));
        const suggested = "user" + (countSnap.size + 1).toString().padStart(2,"0");
        document.getElementById("username").value = suggested;

      } catch(err) { status.innerText = err.message; }
    });

    // Username live validation
    const usernameInput = document.getElementById("username");
    const usernameHint = document.getElementById("usernameHint");
    const usernameStatus = document.getElementById("usernameStatus");

    usernameInput.addEventListener("input", async () => {
      const val = usernameInput.value.trim();
      const numbers = val.replace(/[^0-9]/g, "").length;

      if (val.length === 0) { usernameHint.style.color="#ccc"; usernameStatus.innerText=""; return; }
      if (val.length <8 || numbers<2) { usernameHint.style.color="red"; usernameStatus.innerText=""; return; }

      usernameHint.style.color="green";

      const q = query(collection(db,"users"), where("username","==",val.toLowerCase()));
      const snap = await getDocs(q);
      if (!snap.empty) { usernameStatus.innerText="Already exists"; usernameStatus.style.color="red"; } 
      else { usernameStatus.innerText="Ready for use"; usernameStatus.style.color="green"; }
    });

    // Finish signup
    finishSignup.addEventListener("click", async () => {
      const username = usernameInput.value.trim().toLowerCase();
      if (username.length<8 || username.replace(/[^0-9]/g,"").length<2) { usernameStatus.innerText="Invalid username"; return; }
      if (usernameStatus.innerText==="Already exists") { return; }

      try {
        const cred = await createUserWithEmailAndPassword(auth, signupData.email, signupData.password);
        const uid = cred.user.uid;

        await setDoc(doc(db,"users",uid),{
          email: signupData.email,
          username,
          referralCode: uid.slice(0,6),
          referredBy: signupData.referral||null,
          createdAt: Date.now(),
          followers:0,
          following:0,
          balance:0
        });

        if (signupData.referral) {
          const refQuery = query(collection(db,"users"), where("referralCode","==",signupData.referral));
          const snap = await getDocs(refQuery);
          if (!snap.empty) { 
            const refUser = snap.docs[0];
            await updateDoc(doc(db,"users",refUser.id), { balance: increment(100) });
          }
        }

        usernameStatus.innerText="Account created! Redirecting...";
        setTimeout(()=>{ window.location.href="fyp.html"; },1500);

      } catch(err) { usernameStatus.innerText=err.message; }
    });

  </script>

</body>
</html>
